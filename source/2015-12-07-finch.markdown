---
title: Finch + MySQLã§REST APIã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚‹
date: 2015-12-07
tags: Scala, Finagle, Finch
---

ã“ã‚Œã¯[Scala Advent Calendar 2015ï¼ˆAdventarç‰ˆï¼‰](http://www.adventar.org/calendars/904)7æ—¥ç›®ã§ã™ã€‚6æ—¥ç›®ã¯Hiroyuki-Nagataã•ã‚“ã®[Scalatraã¨non-blocking APIã«ã¤ã„ã¦ãƒ¡ãƒ¢ - ãªã‚“ã¨ãªï½ãã—ã‚ã‚ã›ï¼Ÿã®æ—¥è¨˜](http://nantonaku-shiawase.hatenablog.com/entry/2015/12/06/003259)ã§ã—ãŸã€‚

ã•ã¦ã€ã‚ãŸã—ã¯[Finch](https://github.com/finagle/finch)ã¨ã„ã†Finagleãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ç´¹ä»‹ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚ã‚ˆãã‚ã‚‹Sinatraãƒ©ã‚¤ã‚¯ãªãƒã‚¤ã‚¯ãƒ­ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ã²ã¨ã¤ã§ã™ã€‚Hello Wordã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«å‡ºåŠ›ã—ã¦ã¯ã„çµ‚ã‚ã‚Šã¨ã„ã†ã®ã‚‚å‘³æ°—ãªã„ã®ã§ã€MySQLã«æ¥ç¶šã—ã¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–ã‚Šå‡ºã—ãŸã‚Šç™»éŒ²å‡ºæ¥ã‚‹ã¨ã“ã‚ã¾ã§æŒã£ã¦ã„ãã¾ã™ã€‚

## ã¯ã˜ã‚ã«

ä»Šå›ã¯ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œã‚‹ã“ã¨ã«ã—ã¾ã™ï¼ˆæ›´æ–°ã¨å‰Šé™¤ã¯é¢å€’ã«ãªã£ãŸã®ã§ç„¡ã—ï¼ã”ã‚ã‚“ãªã•ã„ï¼‰

```
GET  /users
GET  /users/:id
POST /users
```

ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå‰ã«MySQLã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã£ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```sql
CREATE TABLE `users` (
  `id`          BIGINT       NOT NULL AUTO_INCREMENT,
  `email`       VARCHAR(255) NOT NULL,
  `screen_name` VARCHAR(255) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB;
```

## ä¾å­˜é–¢ä¿‚

é–‹ç™ºç‰ˆã®0.9.2-SNAPSHOTã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ã¾ãŸMySQLã«ç¹‹ããŸã‚ã«finagle-mysqlã‚‚å…¥ã‚Œã¾ã™ã€‚

build.sbtã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```scala
name := "finchtest"

version := "0.1.0"

scalaVersion := "2.11.7"

resolvers += Resolver.sonatypeRepo("snapshots")

libraryDependencies ++= Seq(
  "com.twitter"         %% "finagle-mysql"   % "6.30.0",
  "com.github.finagle"  %% "finch-core"      % "0.9.2-SNAPSHOT" changing(),
  "com.github.finagle"  %% "finch-argonaut"  % "0.9.2-SNAPSHOT" changing()
)
```

## å®Ÿè£…

æ—¥æœ¬èªã®æƒ…å ±ãŒä¸€åˆ‡ãªã„ã“ã¨ã‚„å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚„ã‚„åˆ†ã‹ã‚Šã¥ã‚‰ã„ã“ã¨ã‚’é™¤ã‘ã°[^1]Finchè‡ªä½“ã®ä½¿ã„ã‹ãŸã¯ãã‚“ãªã«é›£ã—ããªã„ã§ã™ã€‚Finchã‚ˆã‚Šã‚‚finagle-mysqlã®ä½¿ã„ã‹ãŸã‚’èª¿ã¹ã‚‹ã®ã«è‹¦åŠ´ã—ãŸã®ã¯å†…ç·’ã§ã™ã€‚

ä»Šå›ã¯DBã®CRUDæ“ä½œã‚’ã™ã‚‹`User.scala`ã¨`Main.scala`ã®2ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãã¾ã—ãŸã€‚

```scala
package jp.dakatsuka.finch

import argonaut.Argonaut._
import argonaut.CodecJson
import com.twitter.finagle.exp.mysql._
import com.twitter.util.Future

case class User(id: Long, email: String, screen_name: String)

object User {
  implicit val userCodec: CodecJson[User] =
    casecodec3(User.apply, User.unapply)("id", "email", "screen_name")

  def all()(implicit client: Client): Future[Seq[User]] =
    client.select("SELECT * FROM users")(convertToEntity)

  def find(id: Long)(implicit client: Client): Future[Option[User]] =
    client.prepare("SELECt * FROM users WHERE id = ?")(id) map { result =>
      result.asInstanceOf[ResultSet].rows.map(convertToEntity).headOption
    }

  def create(email: String, screen_name: String)(implicit client: Client): Future[Long] =
    client.prepare("INSERT INTO users (email, screen_name) VALUES(?, ?)")(email, screen_name) map { result =>
      result.asInstanceOf[OK].insertId
    }

  def convertToEntity(row: Row): User = {
    val LongValue(id)            = row("id").get
    val StringValue(email)       = row("email").get
    val StringValue(screen_name) = row("screen_name").get

    User(id, email, screen_name)
  }
}
```

```scala
package jp.dakatsuka.finch

import com.twitter.finagle.Http
import com.twitter.finagle.exp.Mysql
import com.twitter.util.Await
import io.finch._
import io.finch.argonaut._

object Main {
  implicit val client = Mysql.client
    .withCredentials("user", "password")
    .withDatabase("database")
    .newRichClient("127.0.0.1:3306")

  case class UserParams(email: String, screen_name: String)

  val userParams: RequestReader[UserParams] = for {
    email <- param("email")
    screen_name <- param("screen_name")
  } yield UserParams(email, screen_name)

  val listUser: Endpoint[Seq[User]] = get("users") {
    Ok(User.all)
  }

  val showUser: Endpoint[User] = get("users" / long) { id: Long =>
    User.find(id).map {
      case Some(user) => Ok(user)
      case _ => NotFound(new Exception("Record Not Found"))
    }
  }

  val createUser: Endpoint[User] = post("users" ? userParams) { p: UserParams =>
    (for {
      id   <- User.create(p.email, p.screen_name)
      user <- User.find(id)
    } yield user) map {
      case Some(user) => Created(user)
      case _ => NotFound(new Exception("Record Not Found"))
    }
  }

  val userService = (listUser :+: showUser :+: createUser).toService

  def main(args: Array[String]): Unit = {
    Await.ready(Http.serve(":8080", userService))
  }
}
```

## å‹•ã‹ã—ã¦ã¿ã‚ˆã†

ã„ã¤ã‚‚ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãŒèµ·å‹•ã—ã¾ã™ã€‚

```
$ sbt run
[info] Set current project to finchtest (in build file:/path/to/project/)
[info] Compiling 1 Scala source to /path/to/project/target/scala-2.11/classes...
[info] Running jp.dakatsuka.finch.Main
12 05, 2015 11:30:49 åˆå¾Œ com.twitter.finagle.Init$$anonfun$1 apply$mcV$sp
æƒ…å ±: Finagle version 6.30.0 (rev=745578b931893c432e51da623287144e548cc489) built at 20151015-163818
```

curlã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
$ curl http://localhost:8080/users
[]

$ curl http://localhost:8080/users/1
Record Not Found

$ curl -X POST http://localhost:8080/users
Required param 'email' not present in the request.

$ curl -X POST -d "email=user1@example.com" http://localhost:8080/users
Required param 'screen_name' not present in the request.

$ curl -X POST -d "email=user1@example.com" -d "screen_name=user1" http://localhost:8080/users
{"id":1,"email":"user1@example.com","screen_name":"user1"}

$ curl -X POST -d "email=user2@example.com" -d "screen_name=user2" http://localhost:8080/users
{"id":2,"email":"user2@example.com","screen_name":"user2"}

$ curl http://localhost:8080/users
[{"id":1,"email":"user1@example.com","screen_name":"user1"},{"id":2,"email":"user2@example.com","screen_name":"user2"}]

$ curl http://localhost:8080/users/1
{"id":1,"email":"user1@example.com","screen_name":"user1"}
```

æœŸå¾…é€šã‚Šã®å‹•ãã§ã™ã­ ğŸ˜

## ã¾ã¨ã‚

Finchã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ

Finagleã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®ä¸Šã«ä¹—ã£ã¦ã„ã‚‹ã®ã§ã€Finagleã«æ…£ã‚Œã¦ã„ã‚‹äººãŒã‚µã‚¯ãƒƒã¨REST APIã‚’å®Ÿè£…ã™ã‚‹ã«ã¯è‰¯ã„é¸æŠè‚¢ã ã¨æ€ã„ã¾ã™ã€‚Finagleä½¿ã£ãŸã“ã¨ãªã„äººã«ã‚‚ã€ã“ã®ã‚³ãƒ¼ãƒ‰é‡ã§é™çš„å‹ä»˜ã‘ã®æ©æµã‚’å—ã‘ãªãŒã‚‰Sinatraãƒ©ã‚¤ã‚¯ã«é–‹ç™ºå‡ºæ¥ã‚‹ã¨ã„ã†ã®ã¯é­…åŠ›çš„ã«æ˜ ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚å€‹äººçš„ã«ã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¿”ã‚Šå€¤ãŒå‹ã§ä¿è¨¼å‡ºæ¥ã‚‹ã®ãŒé«˜ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

ã¡ãªã¿ã«ã€ä¼¼ãŸã‚ˆã†ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦[http4s](http://http4s.org/)ã¨ã„ã†ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã€‚[Scalaã®HTTPã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ http4s è¶…å…¥é–€](https://blog.dakatsuka.jp/2015/11/14/http4s.html)ã§é›‘ã«ç´¹ä»‹ã—ã¦ã„ã‚‹ã®ã§ã€èˆˆå‘³ã‚ã‚‹æ–¹ã¯ã©ã†ãã€‚

[^1]: Scalaãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯ã‚ˆãã‚ã‚‹ã“ã¨
